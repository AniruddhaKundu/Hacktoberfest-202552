{% extends "base.html" %}

{% block content %}
<style>
/* Stock-specific enhancements */
.stock-badge {
    font-size: 0.9rem;
    font-weight: 600;
    padding: 0.4rem 0.8rem;
    border-radius: 0.5rem;
}

.stock-price-table th {
    font-size: 0.85rem;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.stock-price-table td {
    vertical-align: middle;
    font-size: 0.9rem;
}

.price-change-positive {
    color: #28a745 !important;
    font-weight: 600;
}

.price-change-negative {
    color: #dc3545 !important;
    font-weight: 600;
}

.price-change-neutral {
    color: #6c757d !important;
}

.stock-filter-container {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    padding: 0.5rem;
}

#stockLegend .badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.6rem;
    border-radius: 0.4rem;
}

/* Professional Trading Chart Styles */
.trading-chart-container {
    background: #1a1a1a;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.chart-header {
    background: #2d2d2d;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #404040;
}

.stock-select {
    background: #404040;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
}

.stock-select:focus {
    outline: none;
    box-shadow: 0 0 0 2px #00d4aa;
}

.price-info {
    text-align: center;
    color: white;
}

.current-price {
    font-size: 1.5rem;
    font-weight: 700;
    color: #00d4aa;
    margin-bottom: 0.2rem;
}

.price-time {
    font-size: 0.9rem;
    color: #888;
}

.timeframe-selector {
    display: flex;
    gap: 0.5rem;
}

.timeframe-btn {
    background: transparent;
    color: #888;
    border: 1px solid #404040;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.timeframe-btn.active,
.timeframe-btn:hover {
    background: #00d4aa;
    color: white;
    border-color: #00d4aa;
}

.chart-body {
    position: relative;
    height: 400px;
    background: #1a1a1a;
    padding: 1rem;
}

#tradingChart {
    width: 100% !important;
    height: 100% !important;
}

.price-levels {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
}

.previous-close-line {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1);
    padding: 0.5rem;
    border-radius: 4px;
    border-left: 3px solid #666;
}

.previous-close-label {
    color: #888;
    font-size: 0.8rem;
    line-height: 1.2;
}

/* Chart responsive improvements */
@media (max-width: 768px) {
    .chart-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .timeframe-selector {
        justify-content: center;
    }
    
    .chart-body {
        height: 300px;
    }
    
    .previous-close-line {
        display: none;
    }
}

@media (max-width: 576px) {
    .chart-body {
        height: 250px;
    }
}

/* Chart responsive improvements */
.chart-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    height: 400px;
    width: 100%;
}

.chart-container canvas {
    max-width: 100% !important;
    height: auto !important;
}

/* Ensure chart container maintains aspect ratio on mobile */
@media (max-width: 768px) {
    .chart-container {
        height: 300px !important;
    }
    
    .stock-filter-container {
        flex-direction: column;
        align-items: stretch !important;
        gap: 8px !important;
    }
    
    .stock-filter-container .form-select {
        width: 100% !important;
    }
}

@media (max-width: 576px) {
    .chart-container {
        height: 250px !important;
    }
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.metric-highlight {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 1rem;
}
</style>

<!-- Header Stats -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="metric-card">
            <div class="metric-value">{{ available_stocks|length }}</div>
            <div class="metric-label">
                <i class="fas fa-chart-line me-1"></i>
                Tracked Stocks
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="metric-card">
            <div class="metric-value">{{ total_metrics }}</div>
            <div class="metric-label">
                <i class="fas fa-database me-1"></i>
                Total Metrics
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="metric-card">
            <div class="metric-value">{{ total_recommendations }}</div>
            <div class="metric-label">
                <i class="fas fa-brain me-1"></i>
                AI Insights
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">
                <span class="{{ 'sentiment-positive' if latest_sentiment > 0 else 'sentiment-negative' if latest_sentiment < 0 else 'sentiment-neutral' }}">
                    {{ "%.2f"|format(latest_sentiment) }}
                </span>
            </div>
            <div class="metric-label">
                <i class="fas fa-heart-pulse me-1"></i>
                Avg Sentiment
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">
                <button class="btn btn-outline-light btn-sm" onclick="runMultiETL()">
                    <i class="fas fa-play me-1"></i>Run Multi-ETL
                </button>
            </div>
            <div class="metric-label">
                Portfolio Analysis
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Overview -->
{% if available_stocks %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-briefcase me-2"></i>
                    Portfolio Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for stock in available_stocks %}
                    <div class="col-md-2 col-sm-4 col-6 mb-3">
                        <div class="stock-card text-center">
                            <div class="stock-symbol">{{ stock }}</div>
                            <div class="stock-status">
                                <i class="fas fa-circle text-success"></i>
                                Active
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Main Dashboard Content -->
<div class="row">
    <!-- Professional Trading Chart -->
    <div class="col-lg-8 mb-4">
        <div class="trading-chart-container">
            <div class="chart-header">
                <div class="stock-selector">
                    <select id="stockSelector" class="stock-select" onchange="switchStock()">
                        {% for stock in available_stocks %}
                        <option value="{{ stock }}" {% if stock == 'AAPL' %}selected{% endif %}>{{ stock }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="price-info">
                    <div class="current-price" id="currentPrice">201.59 USD</div>
                    <div class="price-time" id="priceTime">09:30</div>
                </div>
                <div class="timeframe-selector">
                    <button class="timeframe-btn active" data-timeframe="1D">1D</button>
                    <button class="timeframe-btn" data-timeframe="5D">5D</button>
                    <button class="timeframe-btn" data-timeframe="1M">1M</button>
                </div>
            </div>
            <div class="chart-body">
                <canvas id="tradingChart"></canvas>
                <div class="price-levels">
                    <div class="previous-close-line">
                        <span class="previous-close-label">Previous close<br>201.00</span>
                    </div>
                </div>
            </div>
        </div>    </div>
    
    <!-- Latest Recommendation -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    Latest AI Insight
                </h5>
            </div>
            <div class="card-body">                {% if recommendations and recommendations|length > 0 %}
                    <div class="mb-3">
                        <strong>{{ recommendations[0].date.strftime('%B %d, %Y') }}</strong>
                        <span class="ms-2 badge bg-primary">{{ recommendations[0].symbol }}</span>
                        <span class="ms-2 status-badge status-{{ 'success' if recommendations[0].confidence_level == 'high' else 'warning' if recommendations[0].confidence_level == 'medium' else 'failed' }}">
                            {{ recommendations[0].confidence_level.title() }} Confidence
                        </span>
                    </div>
                    
                    <p class="text-muted mb-3">{{ recommendations[0].summary }}</p>
                    
                    <div class="d-flex align-items-center mb-2">
                        <span class="me-2">Sentiment:</span>
                        <i class="{{ 'fas fa-arrow-up sentiment-positive' if recommendations[0].sentiment_score > 0.2 else 'fas fa-arrow-down sentiment-negative' if recommendations[0].sentiment_score < -0.2 else 'fas fa-minus sentiment-neutral' }}"></i>
                        <span class="ms-2 {{ 'sentiment-positive' if recommendations[0].sentiment_score > 0.2 else 'sentiment-negative' if recommendations[0].sentiment_score < -0.2 else 'sentiment-neutral' }}">
                            {{ "%.2f"|format(recommendations[0].sentiment_score) }}
                        </span>
                    </div>
                    
                    <a href="/recommendations" class="btn btn-primary btn-sm">
                        View All Insights <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <p>No insights available yet. Run the ETL process to generate AI recommendations.</p>
                        <button class="btn btn-primary" onclick="runETL()">
                            <i class="fas fa-play me-1"></i>Generate Insights
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Data Tables -->
<div class="row">
    <!-- Recent Metrics -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Recent Metrics
                </h5>
                <a href="/metrics" class="btn btn-outline-light btn-sm">View All</a>
            </div>
            <div class="card-body p-0">
                {% if metrics and metrics|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover stock-price-table mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Stock</th>
                                    <th>Open</th>
                                    <th>High</th>
                                    <th>Low</th>
                                    <th>Close</th>
                                    <th>Change</th>
                                    <th>Volume</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for metric in metrics[:10] %}
                                <tr>
                                    <td class="text-muted small">{{ metric.date.strftime('%m/%d') }}</td>                                    <td>
                                        <span class="badge bg-primary stock-badge">{{ metric.symbol }}</span>
                                    </td>
                                    <td class="text-muted small">${{ "%.2f"|format(metric.open_price) }}</td>
                                    <td class="text-muted small">${{ "%.2f"|format(metric.high_price) }}</td>
                                    <td class="text-muted small">${{ "%.2f"|format(metric.low_price) }}</td>
                                    <td class="fw-bold">${{ "%.2f"|format(metric.close_price) }}</td>
                                    <td>
                                        {% set change = metric.close_price - metric.open_price %}
                                        {% set change_pct = (change / metric.open_price * 100) if metric.open_price else 0 %}
                                        <div class="d-flex flex-column">                                            <span class="{{ 'price-change-positive' if change > 0 else 'price-change-negative' if change < 0 else 'price-change-neutral' }}">
                                                {{ "%.2f"|format(change) }}
                                            </span>
                                            <small class="{{ 'price-change-positive' if change > 0 else 'price-change-negative' if change < 0 else 'price-change-neutral' }}">
                                                ({{ "%.2f"|format(change_pct) }}%)
                                            </small>
                                        </div>
                                    </td>
                                    <td class="text-muted small">{{ "{:,}".format(metric.volume) if metric.volume else 'N/A' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center p-4 text-muted">
                        <i class="fas fa-chart-bar fa-2x mb-3"></i>
                        <p>No metrics available yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Job Status -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Recent ETL Jobs
                </h5>
            </div>
            <div class="card-body p-0">
                {% if jobs and jobs|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Records</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for job in jobs[:5] %}
                                <tr>
                                    <td>{{ job.job_date.strftime('%m/%d') }}</td>
                                    <td>
                                        <span class="status-badge status-{{ job.status }}">
                                            {% if job.status == 'success' %}
                                                <i class="fas fa-check me-1"></i>
                                            {% elif job.status == 'failed' %}
                                                <i class="fas fa-times me-1"></i>
                                            {% else %}
                                                <i class="fas fa-spinner fa-spin me-1"></i>
                                            {% endif %}
                                            {{ job.status.title() }}
                                        </span>
                                    </td>
                                    <td class="text-muted">
                                        {% if job.end_time %}
                                            {{ ((job.end_time - job.start_time).total_seconds() / 60)|round(1) }}m
                                        {% else %}
                                            Running...
                                        {% endif %}
                                    </td>
                                    <td>{{ job.records_processed or 0 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center p-4 text-muted">
                        <i class="fas fa-tasks fa-2x mb-3"></i>
                        <p>No ETL jobs recorded yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-primary w-100" onclick="runETL()">
                            <i class="fas fa-play me-2"></i>Run ETL Pipeline
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="/metrics" class="btn btn-outline-primary w-100">
                            <i class="fas fa-chart-bar me-2"></i>View All Metrics
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="/recommendations" class="btn btn-outline-primary w-100">
                            <i class="fas fa-lightbulb me-2"></i>AI Insights
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-secondary w-100" onclick="refreshData()">
                            <i class="fas fa-sync me-2"></i>Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Processing ETL Job...</h5>
                <p class="text-muted mb-0">This may take a few minutes. Please wait.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Metrics data from server
const metricsData = {{ metrics_json|tojson if metrics_json else '[]'|safe }};

// Stock colors for chart
const stockColors = {
    'AAPL': '#1f77b4',    // Blue
    'TSLA': '#ff7f0e',    // Orange  
    'NVDA': '#2ca02c',    // Green
    'MSFT': '#d62728',    // Red
    'META': '#9467bd',    // Purple
    'GOOGL': '#8c564b',   // Brown
    'AMZN': '#e377c2',    // Pink
    'JPM': '#7f7f7f',     // Gray
    'BRK-B': '#bcbd22',   // Olive
    'V': '#17becf'        // Cyan
};

// Create enhanced price chart with multiple stocks
function createPriceChart() {
    const ctx = document.getElementById('priceChart');
    if (!ctx) return;
    
    const chartCtx = ctx.getContext('2d');
    
    // Group metrics by stock symbol
    const stockData = {};
    
    if (metricsData && metricsData.length > 0) {
        metricsData.forEach(metric => {
            if (!metric.symbol || !metric.date || !metric.close_price) return;
            
            if (!stockData[metric.symbol]) {
                stockData[metric.symbol] = [];
            }
            
            stockData[metric.symbol].push({
                date: new Date(metric.date),
                close_price: parseFloat(metric.close_price),
                open_price: parseFloat(metric.open_price),
                high_price: parseFloat(metric.high_price),
                low_price: parseFloat(metric.low_price),
                volume: parseInt(metric.volume) || 0
            });
        });
    }
    
    // Sort data by date for each stock
    Object.keys(stockData).forEach(symbol => {
        stockData[symbol].sort((a, b) => a.date - b.date);
    });
    
    if (Object.keys(stockData).length === 0) {
        ctx.parentElement.innerHTML = '<div class="text-center text-muted p-4"><i class="fas fa-chart-line fa-2x mb-2"></i><br>No data available for chart</div>';
        return;
    }
    
    // Create datasets for each stock
    const datasets = [];
    const legend = document.getElementById('stockLegend');
    legend.innerHTML = '';
    
    Object.keys(stockData).forEach((symbol, index) => {
        const data = stockData[symbol];
        const color = stockColors[symbol] || `hsl(${index * 137.5}, 70%, 50%)`;
        
        datasets.push({
            label: symbol,
            data: data.map(d => ({
                x: d.date.toLocaleDateString(),
                y: d.close_price
            })),
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 2,
            fill: false,
            tension: 0.1,
            pointRadius: 3,
            pointHoverRadius: 5
        });
        
        // Add to legend
        const legendItem = document.createElement('span');
        legendItem.className = 'badge me-2 mb-1';
        legendItem.style.backgroundColor = color;
        legendItem.style.color = 'white';
        legendItem.innerHTML = `${symbol} - $${data[data.length - 1]?.close_price.toFixed(2)}`;
        legend.appendChild(legendItem);
    });
    
    // Get all unique dates for labels
    const allDates = new Set();
    Object.values(stockData).forEach(data => {
        data.forEach(d => allDates.add(d.date.toLocaleDateString()));
    });
    const labels = Array.from(allDates).sort();
    
    window.priceChart = new Chart(chartCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            animation: {
                duration: 750,
                easing: 'easeInOutQuart'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: 'rgba(255,255,255,0.1)',
                    borderWidth: 1,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    grid: {
                        color: 'rgba(0,0,0,0.1)',
                        drawBorder: false
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        },
                        font: {
                            size: 11
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 11
                        },
                        maxTicksLimit: 8
                    }
                }
            }
        }
    });
}

// Update chart based on stock filter
function updatePriceChart() {
    const filterValue = document.getElementById('stockFilter').value;
    const chart = window.priceChart;
    
    if (!chart) return;
    
    chart.data.datasets.forEach((dataset, index) => {
        if (filterValue === 'all') {
            dataset.hidden = false;
        } else {
            dataset.hidden = dataset.label !== filterValue;
        }
    });
    
    chart.update();
}

// Run Multi-Stock ETL job
async function runMultiETL() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    
    try {
        const response = await fetch('/api/run-multi-etl', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                use_mock: false  // Use real data
            })
        });
        
        const result = await response.json();
        
        modal.hide();
        
        if (result.success) {
            alert(`Multi-stock ETL completed successfully for ${result.symbols.length} stocks! Refreshing page...`);
            setTimeout(() => location.reload(), 1000);
        } else {
            alert('Multi-stock ETL job failed: ' + result.message);
        }
    } catch (error) {
        modal.hide();
        alert('Error running multi-stock ETL job: ' + error.message);
    }
}

// Run ETL job (single stock - backwards compatibility)
async function runETL() {
    return runMultiETL();
}

// Refresh data
function refreshData() {
    location.reload();
}

// Initialize chart when page loads
document.addEventListener('DOMContentLoaded', function() {
    createPriceChart();
});

// Handle window resize to properly resize chart
window.addEventListener('resize', function() {
    if (window.priceChart) {
        window.priceChart.resize();
    }
});

// Handle orientation change on mobile devices
window.addEventListener('orientationchange', function() {
    setTimeout(function() {
        if (window.priceChart) {
            window.priceChart.resize();
        }
    }, 500);
});
</script>
{% endblock %}
