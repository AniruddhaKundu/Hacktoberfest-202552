<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance Tracker</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#0b2545;
      --card: rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.06);
      --accent1:#06b6d4; --accent2:#7c3aed;
      --ok:#10b981; --danger:#ef4444;
      --text-color: #fff;
      --input-bg: rgba(255,255,255,0.03);
      --muted-text: rgba(255,255,255,0.8);
      --border-color: rgba(255,255,255,0.03);
      color-scheme: dark;
    }
    
    /* Light Theme */
    body.light{
      --bg1:#f0f9ff; --bg2:#e0f2fe;
      --card: rgba(0,0,0,0.02);
      --glass: rgba(255,255,255,0.8);
      --accent1:#0ea5e9; --accent2:#7c3aed;
      --ok:#10b981; --danger:#ef4444;
      --text-color: #0f172a;
      --input-bg: rgba(255,255,255,0.9);
      --muted-text: rgba(0,0,0,0.7);
      --border-color: rgba(0,0,0,0.1);
      color-scheme: light;
    }
    
    /* Autumn Theme */
    body.autumn{
      --bg1:#92400e; --bg2:#b45309;
      --card: rgba(251,191,36,0.1);
      --glass: rgba(217,119,6,0.15);
      --accent1:#fbbf24; --accent2:#f97316;
      --ok:#84cc16; --danger:#dc2626;
      --text-color: #fef3c7;
      --input-bg: rgba(120,53,15,0.3);
      --muted-text: rgba(254,243,199,0.85);
      --border-color: rgba(217,119,6,0.2);
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex; align-items:flex-start; justify-content:center; padding:28px; color: var(--text-color);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .wrap{
      width:100%; max-width:1100px; display:grid; grid-template-columns: 320px 1fr; gap:18px;
    }

    /* panel */
    .panel{
      background:var(--glass); padding:16px; border-radius:12px; border:1px solid var(--border-color);
      backdrop-filter: blur(6px);
    }
    h2{margin:0 0 12px 0;font-size:1.05rem}
    label{display:block;font-size:0.85rem;color:var(--muted-text); margin:8px 0 6px}
    input[type="text"], input[type="date"], select{
      width:100%; padding:10px 12px; border-radius:8px; border:none; outline:none;
      background: var(--input-bg); color: var(--text-color); font-size:0.95rem;
    }
    .row{display:flex; gap:8px}
    .row .col{flex:1}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600;
    }
    .btn-primary{background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#fff;}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04); color:rgba(255,255,255,0.9)}
    .small{padding:8px 10px;font-size:0.9rem}

    /* right area */
    .topbar{display:flex; gap:12px; align-items:center; margin-bottom:12px}
    .search{
      display:flex; gap:8px; align-items:center; padding:8px; border-radius:10px;
      background: rgba(255,255,255,0.03); flex:1; border:1px solid rgba(255,255,255,0.03);
    }
    .search input{background:transparent;border:none;outline:none;color:#fff;padding:6px}

    .controls{display:flex; gap:8px; align-items:center}

    .table{
      background:var(--card); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03);
      overflow:auto; max-height:60vh;
    }
    table{width:100%; border-collapse:collapse; min-width:720px}
    th, td{padding:10px 8px; text-align:left; border-bottom:1px dashed rgba(255,255,255,0.03)}
    th{font-size:0.85rem; color:rgba(255,255,255,0.9)}
    td{font-size:0.95rem; color:#fff}
    tr:hover td{background:rgba(255,255,255,0.01)}

    .present{background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06)); color:var(--ok); padding:6px 8px; border-radius:8px; display:inline-block}
    .absent{background:linear-gradient(90deg, rgba(239,68,68,0.12), rgba(239,68,68,0.06)); color:var(--danger); padding:6px 8px; border-radius:8px; display:inline-block}
    .toggle-btn{cursor:pointer; padding:6px 10px; border-radius:8px; border:none; background:transparent; color:rgba(255,255,255,0.9)}

    .summary{display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap}
    .card{background:rgba(255,255,255,0.03); padding:10px 12px; border-radius:10px; min-width:140px}
    .muted{color:rgba(255,255,255,0.75); font-size:0.9rem}

    .empty{text-align:center;color:rgba(255,255,255,0.65); padding:24px;border-radius:8px}

    /* responsive */
    @media (max-width:980px){
      .wrap{grid-template-columns:1fr; padding-bottom:20px}
      table{min-width:600px}
    }

    /* small touches */
    .file{display:none}
    .note{font-size:0.85rem;color:var(--muted-text); margin-top:8px}
    .action-inline{display:flex; gap:6px; align-items:center}
    
    /* Theme Switcher */
    .theme-switcher {
      display: flex;
      gap: 6px;
      margin-bottom: 14px;
      padding: 8px;
      background: var(--card);
      border-radius: 10px;
    }
    .theme-btn {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: var(--muted-text);
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }
    .theme-btn.active {
      background: linear-gradient(90deg,var(--accent2),var(--accent1));
      color: #fff;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT PANEL: manage students & date -->
    <div class="panel" aria-label="Manage students">
      <h2>Students & Date</h2>
      
      <!-- Theme Switcher -->
      <div class="theme-switcher">
        <button type="button" class="theme-btn active" onclick="setTheme('dark')">üåô Dark</button>
        <button type="button" class="theme-btn" onclick="setTheme('light')">‚òÄÔ∏è Light</button>
        <button type="button" class="theme-btn" onclick="setTheme('autumn')">üçÇ Autumn</button>
      </div>

      <label for="studentName">Student name</label>
      <input id="studentName" type="text" placeholder="e.g. Rahul Kumar">

      <label for="studentRoll">Roll / ID (optional)</label>
      <input id="studentRoll" type="text" placeholder="e.g. 101">

      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn btn-primary" id="addStudentBtn">Add Student</button>
        <button class="btn btn-ghost" id="clearStudentsBtn">Clear All</button>
      </div>

      <label style="margin-top:14px">Attendance date</label>
      <input id="attDate" type="date">

      <div style="display:flex; gap:8px; margin-top:10px">
        <button class="btn small btn-primary" id="markAllPresent">Mark All Present</button>
        <button class="btn small btn-ghost" id="markAllAbsent">Mark All Absent</button>
      </div>

      <div style="margin-top:14px">
        <button class="btn small btn-ghost" id="exportAll">Export JSON</button>
        <button class="btn small btn-ghost" id="importBtn">Import JSON</button>
        <input id="fileInput" type="file" accept="application/json" class="file">
      </div>

      <p class="note">Attendance is saved in your browser (localStorage). You can export/import JSON for backups.</p>
    </div>

    <!-- RIGHT PANEL: attendance list + summary -->
    <div>
      <div class="panel" style="margin-bottom:12px">
        <div class="topbar">
          <div class="search" role="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.4"/></svg>
            <input id="search" placeholder="Search student name or roll...">
            <button id="clearSearch" class="toggle-btn" style="display:none">‚úï</button>
          </div>

          <div class="controls">
            <select id="viewMode" title="View mode">
              <option value="list">List</option>
              <option value="report">Report</option>
            </select>
            <button class="btn small btn-ghost" id="exportCSV">Export CSV (date)</button>
            <button class="btn small btn-ghost" id="exportAllCSV">Export CSV (all)</button>
          </div>
        </div>

        <div class="summary" id="summary">
          <!-- cards -->
        </div>

        <div class="table" id="tableWrap">
          <!-- table injected here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Theme Switching
    function setTheme(theme) {
      document.body.classList.remove('dark', 'light', 'autumn');
      if (theme !== 'dark') {
        document.body.classList.add(theme);
      }
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      localStorage.setItem('attendance-theme', theme);
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('attendance-theme') || 'dark';
      if (savedTheme !== 'dark') {
        document.body.classList.add(savedTheme);
      }
      document.querySelectorAll('.theme-btn').forEach(btn => {
        const themeName = btn.textContent.toLowerCase().includes('dark') ? 'dark' : 
                         btn.textContent.toLowerCase().includes('light') ? 'light' : 'autumn';
        if (themeName === savedTheme) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    });
    
    // Keys
    const LS_STUD = 'att_students_v1';
    const LS_ATT = 'att_records_v1'; // object: { date1: {studentId: true/false}, date2: {...} }
    // Elements
    const studentName = document.getElementById('studentName');
    const studentRoll = document.getElementById('studentRoll');
    const addStudentBtn = document.getElementById('addStudentBtn');
    const clearStudentsBtn = document.getElementById('clearStudentsBtn');
    const attDate = document.getElementById('attDate');
    const markAllPresent = document.getElementById('markAllPresent');
    const markAllAbsent = document.getElementById('markAllAbsent');
    const exportAll = document.getElementById('exportAll');
    const importBtn = document.getElementById('importBtn');
    const fileInput = document.getElementById('fileInput');
    const search = document.getElementById('search');
    const clearSearch = document.getElementById('clearSearch');
    const viewMode = document.getElementById('viewMode');
    const exportCSV = document.getElementById('exportCSV');
    const exportAllCSV = document.getElementById('exportAllCSV');
    const tableWrap = document.getElementById('tableWrap');
    const summary = document.getElementById('summary');

    // Data
    let students = []; // {id, name, roll, createdAt}
    let records = {};  // { '2025-10-11': { studentId: true/false, ... }, ... }

    // Helpers
    const uid = ()=> 's'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
    const today = ()=> new Date().toISOString().slice(0,10);
    function saveStudents(){ localStorage.setItem(LS_STUD, JSON.stringify(students)); }
    function saveRecords(){ localStorage.setItem(LS_ATT, JSON.stringify(records)); }
    function load(){ students = JSON.parse(localStorage.getItem(LS_STUD) || '[]'); records = JSON.parse(localStorage.getItem(LS_ATT) || '{}'); }
    function setDateInputToTodayIfEmpty(){ if(!attDate.value) attDate.value = today(); }

    // Initialize
    load();
    setDateInputToTodayIfEmpty();
    render();

    // Events
    addStudentBtn.addEventListener('click', ()=>{
      const name = studentName.value.trim();
      const roll = studentRoll.value.trim();
      if(!name){ alert('Enter student name'); studentName.focus(); return; }
      const s = { id: uid(), name, roll, createdAt: Date.now() };
      students.push(s); saveStudents();
      studentName.value=''; studentRoll.value='';
      render();
    });

    clearStudentsBtn.addEventListener('click', ()=>{
      if(!confirm('Clear ALL students and attendance records?')) return;
      students = []; records = {}; saveStudents(); saveRecords(); render();
    });

    attDate.addEventListener('change', ()=>{ render(); });

    markAllPresent.addEventListener('click', ()=>{
      const d = attDate.value || today();
      records[d] = records[d] || {};
      students.forEach(s => records[d][s.id] = true);
      saveRecords(); render();
    });

    markAllAbsent.addEventListener('click', ()=>{
      const d = attDate.value || today();
      records[d] = records[d] || {};
      students.forEach(s => records[d][s.id] = false);
      saveRecords(); render();
    });

    search.addEventListener('input', ()=>{
      clearSearch.style.display = search.value.trim() ? 'inline-block' : 'none';
      render();
    });

    clearSearch.addEventListener('click', ()=>{ search.value=''; clearSearch.style.display='none'; render(); });

    viewMode.addEventListener('change', render);

    exportAll.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({students, records}, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='attendance_backup.json'; a.click(); URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=> {
        try{
          const obj = JSON.parse(r.result);
          if(Array.isArray(obj.students) && typeof obj.records === 'object'){
            if(confirm('Replace current data with imported data?')){
              students = obj.students; records = obj.records;
              saveStudents(); saveRecords(); render(); alert('Imported');
            }
          } else alert('Invalid file format');
        } catch(err){ alert('Invalid JSON') }
      };
      r.readAsText(f); e.target.value='';
    });

    exportCSV.addEventListener('click', ()=> {
      const d = attDate.value || today();
      downloadCSVForDate(d);
    });

    exportAllCSV.addEventListener('click', ()=> {
      downloadCSVAllDates();
    });

    // Render functions
    function render(){
      setDateInputToTodayIfEmpty();
      if(viewMode.value === 'list') renderListView();
      else renderReportView();
      renderSummary();
    }

    function filteredStudents(){
      const q = search.value.trim().toLowerCase();
      if(!q) return students.slice().sort((a,b)=>a.name.localeCompare(b.name));
      return students.filter(s => (s.name + ' ' + (s.roll||'')).toLowerCase().includes(q)).sort((a,b)=>a.name.localeCompare(b.name));
    }

    function renderListView(){
      const list = filteredStudents();
      const d = attDate.value || today();
      const rec = records[d] || {};
      if(list.length === 0){
        tableWrap.innerHTML = `<div class="empty">No students found. Add students using the left panel.</div>`;
        return;
      }
      let html = `<table aria-label="Attendance table"><thead><tr><th>Roll</th><th>Name</th><th style="width:160px">Status</th><th>Actions</th></tr></thead><tbody>`;
      list.forEach(s=>{
        const status = (s.id in rec) ? (rec[s.id] ? 'present' : 'absent') : 'none';
        html += `<tr data-id="${s.id}">
                  <td>${escapeHtml(s.roll || '')}</td>
                  <td>${escapeHtml(s.name)}</td>
                  <td>${status === 'present' ? `<span class="present">Present</span>` : status==='absent' ? `<span class="absent">Absent</span>` : `<span class="muted">Not marked</span>`}</td>
                  <td class="action-inline">
                    <button class="toggle-btn" onclick="toggleStatus('${s.id}')">${status === 'present' ? 'Mark Absent' : 'Mark Present'}</button>
                    <button class="toggle-btn" onclick="editStudent('${s.id}')">Edit</button>
                    <button class="toggle-btn" onclick="deleteStudent('${s.id}')">Delete</button>
                  </td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      tableWrap.innerHTML = html;
    }

    function renderReportView(){
      // report: per-student % over all recorded dates
      if(students.length === 0){
        tableWrap.innerHTML = `<div class="empty">No students to report on.</div>`;
        return;
      }
      const dates = Object.keys(records).sort();
      if(dates.length === 0){
        tableWrap.innerHTML = `<div class="empty">No attendance records yet.</div>`;
        return;
      }
      let html = `<table aria-label="Attendance report"><thead><tr><th>Roll</th><th>Name</th><th>Total Days</th><th>Present</th><th>Absent</th><th>Attendance %</th></tr></thead><tbody>`;
      students.forEach(s=>{
        let total=0, present=0;
        dates.forEach(d=>{
          if(records[d] && s.id in records[d]){
            total++;
            if(records[d][s.id]) present++;
          }
        });
        const absent = total - present;
        const pct = total ? Math.round((present/total)*100) : 0;
        html += `<tr>
                  <td>${escapeHtml(s.roll||'')}</td>
                  <td>${escapeHtml(s.name)}</td>
                  <td>${total}</td>
                  <td>${present}</td>
                  <td>${absent}</td>
                  <td>${pct}%</td>
                 </tr>`;
      });
      html += `</tbody></table>`;
      tableWrap.innerHTML = html;
    }

    function renderSummary(){
      const d = attDate.value || today();
      const rec = records[d] || {};
      const total = students.length;
      const present = students.filter(s => rec[s.id] === true).length;
      const absent = students.filter(s => rec[s.id] === false).length;
      const unmarked = total - (present + absent);
      const pct = total ? Math.round((present/total)*100) : 0;
      summary.innerHTML = `
        <div class="card"><div class="muted">Date</div><div style="font-weight:700">${d}</div></div>
        <div class="card"><div class="muted">Total</div><div style="font-weight:700">${total}</div></div>
        <div class="card"><div class="muted">Present</div><div style="font-weight:700">${present}</div></div>
        <div class="card"><div class="muted">Absent</div><div style="font-weight:700">${absent}</div></div>
        <div class="card"><div class="muted">Unmarked</div><div style="font-weight:700">${unmarked}</div></div>
        <div class="card"><div class="muted">Attendance %</div><div style="font-weight:700">${pct}%</div></div>
      `;
    }

    // Actions accessible from HTML buttons
    window.toggleStatus = function(studentId){
      const d = attDate.value || today();
      records[d] = records[d] || {};
      const current = records[d][studentId];
      records[d][studentId] = !current;
      saveRecords(); render();
    };

    window.editStudent = function(studentId){
      const s = students.find(x=>x.id===studentId); if(!s) return;
      const newName = prompt('Edit name', s.name);
      if(newName === null) return;
      s.name = newName.trim() || s.name;
      const newRoll = prompt('Edit roll/id (optional)', s.roll || '');
      if(newRoll !== null) s.roll = newRoll.trim();
      saveStudents(); render();
    };

    window.deleteStudent = function(studentId){
      if(!confirm('Delete student? This will NOT remove historical attendance entries for that id.')) return;
      students = students.filter(s=>s.id !== studentId);
      saveStudents(); render();
    };

    // CSV exports
    function downloadCSVForDate(d){
      const rec = records[d] || {};
      let rows = [['Roll','Name','Status','Date']];
      students.forEach(s=>{
        const status = (s.id in rec) ? (rec[s.id] ? 'Present' : 'Absent') : 'Not marked';
        rows.push([s.roll||'', s.name, status, d]);
      });
      downloadCSV(rows, `attendance_${d}.csv`);
    }

    function downloadCSVAllDates(){
      const dates = Object.keys(records).sort();
      if(dates.length === 0){ alert('No records to export'); return; }
      let rows = [['Date','Roll','Name','Status']];
      dates.forEach(d=>{
        const rec = records[d] || {};
        students.forEach(s=>{
          const status = (s.id in rec) ? (rec[s.id] ? 'Present' : 'Absent') : 'Not marked';
          rows.push([d, s.roll||'', s.name, status]);
        });
      });
      downloadCSV(rows, `attendance_all_dates.csv`);
    }

    function downloadCSV(rows, filename){
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // Utility
    function escapeHtml(t){ if(!t) return ''; return String(t).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

    // Initialize with a couple of sample students (only if none exist)
    if(students.length === 0){
      // sample - comment out if you don't want samples
      // students.push({id:uid(), name:'Asha Verma', roll:'01', createdAt:Date.now()});
      // students.push({id:uid(), name:'Rahul Kumar', roll:'02', createdAt:Date.now()});
      // saveStudents();
    }

    // render initial
    render();

    // Optional: show quick hint if no students on first load
    if(students.length === 0){
      tableWrap.innerHTML = `<div class="empty">No students yet ‚Äî add students using left panel to start taking attendance.</div>`;
    }
  </script>
</body>
</html>
